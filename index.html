<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Object Security of CoAP (OSCOAP)</title>

  <style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  ul.toc, #rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 500px);
    width: 300px;
    padding: 0 1em;
    z-index: 1;
  }
  #rfc\.toc {
    top: 16px;
  }
  ul.toc {
    top: 80px;
    overflow: auto;
  }

  body {
    padding-left: 1.5em;
    padding-right: 29em;
  }
}

body {
  font: 15px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 130%;
  margin: 2.5em auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 30px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc, ul.toc ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p {
  font-size: 20px;
  font-weight: 300;
  line-height: 130%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
  /*]]>*/</style>

  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Terminology"/>
<link href="#rfc.section.2" rel="Chapter" title="2 The Object-Security Option"/>
<link href="#rfc.section.3" rel="Chapter" title="3 The Security Context"/>
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Security Context Definition"/>
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Security Context Derivation"/>
<link href="#rfc.section.4" rel="Chapter" title="4 Protected CoAP Message Fields"/>
<link href="#rfc.section.5" rel="Chapter" title="5 The COSE Object"/>
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Plaintext"/>
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Additional Authenticated Data"/>
<link href="#rfc.section.6" rel="Chapter" title="6 Protecting CoAP Messages"/>
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Replay and Freshness Protection"/>
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 Protecting the Request"/>
<link href="#rfc.section.6.3" rel="Chapter" title="6.3 Verifying the Request"/>
<link href="#rfc.section.6.4" rel="Chapter" title="6.4 Protecting the Response"/>
<link href="#rfc.section.6.5" rel="Chapter" title="6.5 Verifying the Response"/>
<link href="#rfc.section.7" rel="Chapter" title="7 Security Considerations"/>
<link href="#rfc.section.8" rel="Chapter" title="8 Privacy Considerations"/>
<link href="#rfc.section.9" rel="Chapter" title="9 IANA Considerations"/>
<link href="#rfc.section.9.1" rel="Chapter" title="9.1 Sid Registration"/>
<link href="#rfc.section.9.2" rel="Chapter" title="9.2 CoAP Option Number Registration"/>
<link href="#rfc.section.9.3" rel="Chapter" title="9.3 Media Type Registrations"/>
<link href="#rfc.section.9.4" rel="Chapter" title="9.4 CoAP Content Format Registration"/>
<link href="#rfc.section.10" rel="Chapter" title="10 Acknowledgments"/>
<link href="#rfc.references" rel="Chapter" title="11 References"/>
<link href="#rfc.references.1" rel="Chapter" title="11.1 Normative References"/>
<link href="#rfc.references.2" rel="Chapter" title="11.2 Informative References"/>
<link href="#rfc.appendix.A" rel="Chapter" title="A Overhead"/>
<link href="#rfc.appendix.A.1" rel="Chapter" title="A.1 Length of the Object-Security Option"/>
<link href="#rfc.appendix.A.2" rel="Chapter" title="A.2 Size of the COSE Object"/>
<link href="#rfc.appendix.A.3" rel="Chapter" title="A.3 Message Expansion"/>
<link href="#rfc.appendix.A.4" rel="Chapter" title="A.4 Example"/>
<link href="#rfc.appendix.B" rel="Chapter" title="B Examples"/>
<link href="#rfc.appendix.B.1" rel="Chapter" title="B.1 Secure Access to Sensor"/>
<link href="#rfc.appendix.B.2" rel="Chapter" title="B.2 Secure Subscribe to Sensor"/>
<link href="#rfc.appendix.C" rel="Chapter" title="C Object Security of Content (OSCON)"/>
<link href="#rfc.appendix.C.1" rel="Chapter" title="C.1 Overhead OSCON"/>
<link href="#rfc.appendix.C.2" rel="Chapter" title="C.2 MAC Only"/>
<link href="#rfc.appendix.C.3" rel="Chapter" title="C.3 Signature Only"/>
<link href="#rfc.appendix.C.4" rel="Chapter" title="C.4 Authenticated Encryption with Additional Data (AEAD)"/>
<link href="#rfc.appendix.C.5" rel="Chapter" title="C.5 Symmetric Encryption with Asymmetric Signature (SEAS)"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.5.1 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Selander, G., Mattsson, J., Palombini, F., and L. Seitz" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-selander-ace-object-security-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2016-9-15" />
  <meta name="dct.abstract" content="This memo defines Object Security of CoAP (OSCOAP), a method for application layer protection of message exchanges with the Constrained Application Protocol (CoAP), using the CBOR Object Signing and Encryption (COSE) format. OSCOAP provides end-to-end encryption, integrity and replay protection to CoAP payload, options, and header fields, as well as a secure binding between CoAP request and response messages. The use of OSCOAP is signaled with the CoAP option Object-Security, also defined in this memo." />
  <meta name="description" content="This memo defines Object Security of CoAP (OSCOAP), a method for application layer protection of message exchanges with the Constrained Application Protocol (CoAP), using the CBOR Object Signing and Encryption (COSE) format. OSCOAP provides end-to-end encryption, integrity and replay protection to CoAP payload, options, and header fields, as well as a secure binding between CoAP request and response messages. The use of OSCOAP is signaled with the CoAP option Object-Security, also defined in this memo." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">ACE Working Group</td>
  <td class="right">G. Selander</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">J. Mattsson</td>
</tr>
<tr>
  <td class="left">Intended status: Standards Track</td>
  <td class="right">F. Palombini</td>
</tr>
<tr>
  <td class="left">Expires: March 19, 2017</td>
  <td class="right">Ericsson AB</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">L. Seitz</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">SICS Swedish ICT</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">September 15, 2016</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Object Security of CoAP (OSCOAP)<br />
  <span class="filename">draft-selander-ace-object-security-latest</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>This memo defines Object Security of CoAP (OSCOAP), a method for application layer protection of message exchanges with the Constrained Application Protocol (CoAP), using the CBOR Object Signing and Encryption (COSE) format. OSCOAP provides end-to-end encryption, integrity and replay protection to CoAP payload, options, and header fields, as well as a secure binding between CoAP request and response messages. The use of OSCOAP is signaled with the CoAP option Object-Security, also defined in this memo.</p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on March 19, 2017.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2016 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Terminology</a></li>
</ul><li>2.   <a href="#rfc.section.2">The Object-Security Option</a></li>
<li>3.   <a href="#rfc.section.3">The Security Context</a></li>
<ul><li>3.1.   <a href="#rfc.section.3.1">Security Context Definition</a></li>
<li>3.2.   <a href="#rfc.section.3.2">Security Context Derivation</a></li>
</ul><li>4.   <a href="#rfc.section.4">Protected CoAP Message Fields</a></li>
<li>5.   <a href="#rfc.section.5">The COSE Object</a></li>
<ul><li>5.1.   <a href="#rfc.section.5.1">Plaintext</a></li>
<li>5.2.   <a href="#rfc.section.5.2">Additional Authenticated Data</a></li>
</ul><li>6.   <a href="#rfc.section.6">Protecting CoAP Messages</a></li>
<ul><li>6.1.   <a href="#rfc.section.6.1">Replay and Freshness Protection</a></li>
<li>6.2.   <a href="#rfc.section.6.2">Protecting the Request</a></li>
<li>6.3.   <a href="#rfc.section.6.3">Verifying the Request</a></li>
<li>6.4.   <a href="#rfc.section.6.4">Protecting the Response</a></li>
<li>6.5.   <a href="#rfc.section.6.5">Verifying the Response</a></li>
</ul><li>7.   <a href="#rfc.section.7">Security Considerations</a></li>
<li>8.   <a href="#rfc.section.8">Privacy Considerations</a></li>
<li>9.   <a href="#rfc.section.9">IANA Considerations</a></li>
<ul><li>9.1.   <a href="#rfc.section.9.1">Sid Registration</a></li>
<li>9.2.   <a href="#rfc.section.9.2">CoAP Option Number Registration</a></li>
<li>9.3.   <a href="#rfc.section.9.3">Media Type Registrations</a></li>
<li>9.4.   <a href="#rfc.section.9.4">CoAP Content Format Registration</a></li>
</ul><li>10.   <a href="#rfc.section.10">Acknowledgments</a></li>
<li>11.   <a href="#rfc.references">References</a></li>
<ul><li>11.1.   <a href="#rfc.references.1">Normative References</a></li>
<li>11.2.   <a href="#rfc.references.2">Informative References</a></li>
</ul><li>Appendix A.   <a href="#rfc.appendix.A">Overhead</a></li>
<ul><li>A.1.   <a href="#rfc.appendix.A.1">Length of the Object-Security Option</a></li>
<li>A.2.   <a href="#rfc.appendix.A.2">Size of the COSE Object</a></li>
<li>A.3.   <a href="#rfc.appendix.A.3">Message Expansion</a></li>
<li>A.4.   <a href="#rfc.appendix.A.4">Example</a></li>
</ul><li>Appendix B.   <a href="#rfc.appendix.B">Examples</a></li>
<ul><li>B.1.   <a href="#rfc.appendix.B.1">Secure Access to Sensor</a></li>
<li>B.2.   <a href="#rfc.appendix.B.2">Secure Subscribe to Sensor</a></li>
</ul><li>Appendix C.   <a href="#rfc.appendix.C">Object Security of Content (OSCON)</a></li>
<ul><li>C.1.   <a href="#rfc.appendix.C.1">Overhead OSCON</a></li>
<li>C.2.   <a href="#rfc.appendix.C.2">MAC Only</a></li>
<li>C.3.   <a href="#rfc.appendix.C.3">Signature Only</a></li>
<li>C.4.   <a href="#rfc.appendix.C.4">Authenticated Encryption with Additional Data (AEAD)</a></li>
<li>C.5.   <a href="#rfc.appendix.C.5">Symmetric Encryption with Asymmetric Signature (SEAS)</a></li>
</ul><li><a href="#rfc.authors">Authors' Addresses</a></li>


  </ul>

  <h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> <a href="#intro" id="intro">Introduction</a></h1>
<p id="rfc.section.1.p.1">The Constrained Application Protocol (CoAP) <a href="#RFC7252">[RFC7252]</a> is a web application protocol, designed for constrained nodes and networks <a href="#RFC7228">[RFC7228]</a>. CoAP specifies the use of proxies for scalability and efficiency. At the same time CoAP references DTLS <a href="#RFC6347">[RFC6347]</a> for security. Proxy operations on CoAP messages require DTLS to be terminated at the proxy. The proxy therefore not only has access to the data required for performing the intended proxy functionality, but is also able to eavesdrop on, or manipulate any part of the CoAP payload and metadata, in transit between client and server. The proxy can also inject, delete, or reorder packages without being protected or detected by DTLS.</p>
<p id="rfc.section.1.p.2">This memo defines Object Security of CoAP (OSCOAP), a data object based security protocol, protecting CoAP message exchanges end-to-end, across intermediary nodes. An analysis of end-to-end security for CoAP messages through intermediary nodes is performed in <a href="#I-D.hartke-core-e2e-security-reqs">[I-D.hartke-core-e2e-security-reqs]</a>, this specification addresses the forwarding case.</p>
<p id="rfc.section.1.p.3">The solution provides an in-layer security protocol for CoAP which does not depend on underlying layers and is therefore favorable for providing security for "CoAP over foo", e.g. CoAP messages passing over both reliable and unreliable transport, CoAP over IEEE 802.15.4 IE <a href="#I-D.bormann-6lo-coap-802-15-ie">[I-D.bormann-6lo-coap-802-15-ie]</a>.</p>
<p id="rfc.section.1.p.4">OSCOAP builds on CBOR Object Signing and Encryption (COSE) <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>, providing end-to-end encryption, integrity, and replay protection. The use of OSCOAP is signaled with the CoAP option Object-Security, also defined in this memo. The solution transforms an unprotected CoAP message into a protected CoAP message in the following way: the unprotected CoAP message is protected by including payload (if present), certain options, and header fields in a COSE object. The message fields that have been encrypted are removed from the message whereas the Object-Security option and the COSE object are added. We call the result the "protected" CoAP message. Thus OSCOAP is a security protocol based on the exchange of protected CoAP messages (see <a href="#oscoap-ex">Figure 1</a>).</p>
<div id="rfc.figure.1"/>
<div id="oscoap-ex"/>
<pre>
Client                                           Server
   |  request:                                     |
   |    GET example.com                            |
   |    [Header, Token, Options:{...,              |
   |     Object-Security:COSE object}]             |
   +----------------------------------------------&gt;|
   |  response:                                    |
   |    2.05 (Content)                             |
   |    [Header, Token, Options:{...,              |
   |     Object-Security:-}, Payload:COSE object]  |
   |&lt;----------------------------------------------+
   |                                               |
</pre>
<p class="figure">Figure 1: Sketch of OSCOAP</p>
<p id="rfc.section.1.p.5">OSCOAP provides protection of CoAP payload, certain options, and header fields, as well as a secure binding between CoAP request and response messages, and freshness of requests and responses. It may be used in extremely constrained settings, where DTLS cannot be supported. Alternatively, OSCOAP can be combined with DTLS, thereby enabling end-to-end security of CoAP payload, in combination with hop-by-hop protection of the entire CoAP message, during transport between end-point and intermediary node. Examples of the use of OSCOAP are given in <a href="#appendix-d">Appendix B</a>.</p>
<p id="rfc.section.1.p.6">The message protection provided by OSCOAP can alternatively be applied only to the payload of individual messages. We call this object security of content (OSCON) and it is defined in <a href="#mode-payl">Appendix C</a>.</p>
<h1 id="rfc.section.1.1"><a href="#rfc.section.1.1">1.1.</a> <a href="#terminology" id="terminology">Terminology</a></h1>
<p id="rfc.section.1.1.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>. These words may also appear in this document in lowercase, absent their normative meanings.</p>
<p id="rfc.section.1.1.p.2">Readers are expected to be familiar with the terms and concepts described in <a href="#RFC7252">[RFC7252]</a> and <a href="#RFC7641">[RFC7641]</a>.</p>
<p id="rfc.section.1.1.p.3">Terminology for constrained environments, such as "constrained device", "constrained-node network", is defined in <a href="#RFC7228">[RFC7228]</a>.</p>
<p id="rfc.section.1.1.p.4">Two different scopes of object security are defined:</p>
<p/>

<ul>
  <li>OSCOAP = object security of CoAP, signaled with the Object-Security option.</li>
  <li>OSCON = object security of content, signaled with Content Format/Media Type set to application/oscon (defined in <a href="#mode-payl">Appendix C</a>).</li>
</ul>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#obj-sec-option-section" id="obj-sec-option-section">The Object-Security Option</a></h1>
<p id="rfc.section.2.p.1">The Object-Security option indicates that OSCOAP is used to protect the CoAP message exchange. The protection is achieved by means of a COSE object included in the protected CoAP message, as detailed in <a href="#sec-obj-cose">Section 5</a>.</p>
<p id="rfc.section.2.p.2">The Object-Security option is critical, safe to forward, part of the cache key, and not repeatable. <a href="#obj-sec-option">Figure 2</a> illustrates the structure of the Object-Security option.</p>
<p id="rfc.section.2.p.3">A CoAP proxy SHOULD NOT cache a response to a request with an Object-Security option, since the response is only applicable to the original client's request. The Object-Security option is included in the cache key for backward compatibility with proxies not recognizing the Object-Security option.  The effect of this is that messages with the Object-Security option will never generate cache hits. To further prevent caching, a Max-Age option with value zero SHOULD be added to the protected CoAP responses.</p>
<div id="rfc.figure.2"/>
<div id="obj-sec-option"/>
<pre>
+-----+---+---+---+---+-----------------+--------+--------+
| No. | C | U | N | R | Name            | Format | Length |
+-----+---+---+---+---+-----------------+--------+--------|
| TBD | x |   |   |   | Object-Security | opaque | 0-     |
+-----+---+---+---+---+-----------------+--------+--------+
     C=Critical, U=Unsafe, N=NoCacheKey, R=Repeatable
</pre>
<p class="figure">Figure 2: The Object-Security Option</p>
<p id="rfc.section.2.p.4">The length of the Object-Security option depends on whether the unprotected message has payload, on the set of options that are included in the unprotected message, the length of the integrity tag, and the length of the information identifying the security context.</p>
<p/>

<ul>
  <li>If the unprotected message has payload, then the COSE object is the payload of the protected message (see <a href="#protected-coap-formatting-req">Section 6.2</a> and <a href="#protected-coap-formatting-resp">Section 6.4</a>), and the Object-Security option has length zero. An endpoint receiving a CoAP message with payload, that also contains a non-empty Object-Security option SHALL treat it as malformed and reject it.</li>
  <li>If the unprotected message does not have payload, then the COSE object is the value of the Object-Security option and the length of the Object-Security option is equal to the size of the COSE object. An endpoint receiving a CoAP message without payload, that also contains an empty Object-Security option SHALL treat it as malformed and reject it.</li>
</ul>
<p id="rfc.section.2.p.6">An example of option length is given in <a href="#appendix-a">Appendix A</a>.</p>
<h1 id="rfc.section.3"><a href="#rfc.section.3">3.</a> <a href="#sec-context-section" id="sec-context-section">The Security Context</a></h1>
<p id="rfc.section.3.p.1">OSCOAP uses COSE with an Authenticated Encryption with Additional Data (AEAD) algorithm. The specification requires that client and server establish a security context to apply to the COSE objects protecting the CoAP messages. In this section we define the security context, and also specify how to establish a security context in client and server based on common keying material and a key derivation function (KDF).</p>
<p id="rfc.section.3.p.2">The EDHOC protocol <a href="#I-D.selander-ace-cose-ecdhe">[I-D.selander-ace-cose-ecdhe]</a> enables the establishment of forward secret keying material, and negotiation of KDF and AEAD, it thus provides all necessary pre-requisite steps for using OSCOAP as defined here.</p>
<h1 id="rfc.section.3.1"><a href="#rfc.section.3.1">3.1.</a> <a href="#sec-context-def-section" id="sec-context-def-section">Security Context Definition</a></h1>
<p id="rfc.section.3.1.p.1">The security context is the set of information elements necessary to carry out the cryptographic operations in OSCOAP. Each security context is identified by a Context Identifier. A Context Identifier that is no longer in use can be reassigned to a new security context.</p>
<p id="rfc.section.3.1.p.2">For each endpoint, the security context is composed by a "Common Context", a "Sender Context" and a "Recipient Context". The Common Context includes common security material. The endpoint protects the messages sent using the Sender Context. The endpoint verifies the messages received using the Recipient Context.  In communication between two endpoints, the Sender Context of one endpoint matches the Recipient Context of the other endpoint, and vice versa. Note that, because of that, the two security contexts identified by the same Context Identifiers in the two endpoints are not the same, but they are partly mirrored.</p>
<p id="rfc.section.3.1.p.3">An example is shown in <a href="#sec-context-ex">Figure 3</a>.</p>
<div id="rfc.figure.3"/>
<div id="sec-context-ex"/>
<pre>
               .-Cid = Cid1-.            .-Cid = Cid1-.  
               | context:   |            | context:   |
               |  Alg,      |            |  Alg,      |
               |  Sender,   |            |  Recipient,|
               |  Recipient |            |  Sender    |
               '------------'            '------------'
                   Client                   Server
                      |                       |
Retrieve context for  | request:              |
 target resource      |  [Token = Token1,     |
Protect request with  |    Cid=Cid1, ...]     |
  Sender              +----------------------&gt;| Retrieve context with
                      |                       |  Cid = Cid1
                      |                       | Verify request with
                      |                       |  Recipient
                      | response:             | Protect response with
                      |  [Token = Token1, ...]|  Sender 
Retrieve context with |&lt;----------------------+
 Token = Token1       |                       |
Verify request with   |                       |
 Recipient            |                       |
</pre>
<p class="figure">Figure 3: Retrieval and use of the Security Context</p>
<p id="rfc.section.3.1.p.4">The Common Context structure contains the following parameters:</p>
<p/>

<ul>
  <li>Context Identifier (Cid). Variable length byte string that identifies the security context. Immutable.</li>
  <li>Algorithm (Alg). Value that identifies the COSE AEAD algorithm to use for encryption. Immutable.</li>
  <li>Base Key (base_key). Byte string containing the key used to derive the security context <a href="#sec-context-est-section">Section 3.2</a>.</li>
</ul>
<p id="rfc.section.3.1.p.6">The Sender Context structure contains the following parameters:</p>
<p/>

<ul>
  <li>Sender ID. Variable length byte string identifying the sending endpoint. Immutable.</li>
  <li>Sender Key. Byte string containing the symmetric key to protect messages to send. Length is determined by Algorithm. Immutable.</li>
  <li>Sender IV. Byte string containing the static IV to protect messages to send. Length is determined by Algorithm. Immutable.</li>
  <li>Sender Sequence Number. Non-negative integer enumerating the COSE objects that the endpoint sends, associated to the Context Identifier. It is used for replay protection, and to generate unique IVs for the AEAD. Initialized to 0. Maximum value is determined by Algorithm.</li>
</ul>
<p id="rfc.section.3.1.p.8">The Recipient Context structure contains the following parameters:</p>
<p/>

<ul>
  <li>Recipient ID. Variable length byte string identifying the sending endpoint. Immutable.</li>
  <li>Recipient Key. Byte string containing the symmetric key to verify messages received. Length is determined by the Algorithm. Immutable.</li>
  <li>Recipient IV. Byte string containing the static IV to verify messages received. Length is determined by Algorithm. Immutable.</li>
  <li>Recipient Sequence Number. Non-negative integer enumerating the COSE objects received, associated to the Context Identifier. It is used for replay protection, and to generate unique IVs for the AEAD. Initialized to 0. Maximum value is determined by Algorithm.</li>
  <li>Replay Window. The replay protection window for messages received, equivalent to the functionality described in Section 4.1.2.6 of <a href="#RFC6347">[RFC6347]</a>. The default window size is 64.</li>
</ul>
<p id="rfc.section.3.1.p.10">The ordered 3-tuple (Cid, Sender ID, Sender Sequence Number) is called Transaction Identifier (Tid), and SHALL be unique for each COSE object and server. The Tid is used as a unique challenge in the COSE object of the protected CoAP request. The Tid is part of the Additional Authenticated Data (AAD, see <a href="#sec-obj-cose">Section 5</a>) of the protected CoAP response message, which is how the challenge becomes signed by the server.</p>
<p id="rfc.section.3.1.p.11">The client and server may change roles using the same security context. The former server will then make the request using the Sender Context, the former client will verify the request using its Recipient Context etc.</p>
<h1 id="rfc.section.3.2"><a href="#rfc.section.3.2">3.2.</a> <a href="#sec-context-est-section" id="sec-context-est-section">Security Context Derivation</a></h1>
<p id="rfc.section.3.2.p.1">Given a shared secret keying material and a common key derivation function, the client and server can derive the security context necessary to run OSCOAP. The procedure described here assumes that the keying material is uniformly random and that the key derivation function is HKDF <a href="#RFC5869">[RFC5869]</a>. This is for example the case after having used EDHOC <a href="#I-D.selander-ace-cose-ecdhe">[I-D.selander-ace-cose-ecdhe]</a>.</p>
<p id="rfc.section.3.2.p.2">Assumptions:</p>
<p/>

<ul>
  <li>The hash function, denoted HKDF, is the HMAC based key derivation function defined in <a href="#RFC5869">[RFC5869]</a> with specified hash function</li>
  <li>The shared secret keying material, denoted base_key, is uniformly pseudo-random of length at least equal to the output of the specified hash function</li>
</ul>
<p id="rfc.section.3.2.p.4">The security context parameters SHALL be derived using the HKDF-Expand primitive <a href="#RFC5869">[RFC5869]</a>:</p>
<p id="rfc.section.3.2.p.5">Key = HKDF-Expand(base_key, info, key_length),</p>
<p id="rfc.section.3.2.p.6">where:</p>
<p/>

<ul>
  <li>base_key is defined above</li>
  <li>info = Sender ID/Recipient ID || "IV"/"Key"</li>
  <li>key_length is the key size of the AEAD algorithm</li>
</ul>
<p id="rfc.section.3.2.p.8">The Sender/Recipient Key shall be derived using the Sender/Recipient ID concatenated with the label "Key". The Sender/Recipient IV shall be derived using the Sender/Recipient ID concatenated with the label "IV".</p>
<p id="rfc.section.3.2.p.9">With the mandatory OSCOAP algorithm AES-CCM-64-64-128 (see Section 10.2 in <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>), key_length for the keys is 128 bits and key_length for the static IVs is 56 bits.</p>
<p id="rfc.section.3.2.p.10">The Context Identifier SHALL be unique for all security contexts used by the party being server. This can be achieved by the server, or trusted third party, assigning identifiers in a non-colliding way. In case it is acceptable for the application that the client and server switch roles, the application SHALL also ensure that the Context Identifier is unique for all contexts used by the party being the client. This can be achieved by storing the Cid paired with some sort of communication identifier (e.g. the server's address).</p>
<p id="rfc.section.3.2.p.11">The size of Cid depends on the number of simultaneous clients, and must be chosen so that the server can uniquely identify the requesting client. Cids of different lengths can be used by different clients. In the case of an ACE-based authentication and authorization model <a href="#I-D.ietf-ace-oauth-authz">[I-D.ietf-ace-oauth-authz]</a>, the Authorization Server can define the context identifier of all clients interacting with a particular server, in which case the size of Cid can be proportional to the logarithm of the number of authorized clients. It is RECOMMENDED to start assigning Cids of length 1 byte (0x00, 0x01, &#8230;, 0xff), and then when all 1 byte Cids are in use, start handling out Cids with a length of two bytes (0x0000, 0x0001, &#8230;, 0xffff), and so on. Note that a Cid with the value 0x00 is considered different from the Cid with the value 0x0000.</p>
<p id="rfc.section.3.2.p.12">In case of EDHOC, party V (typically the server) can use the key identifier of its ephemeral public key (kid_ev, Section 1.1 of <a href="#I-D.selander-ace-cose-ecdhe">[I-D.selander-ace-cose-ecdhe]</a>) to label the derived keying material, base_key, and to identify the security context derived from base_key. In this case, Cid would be assigned the value kid_ev.</p>
<p id="rfc.section.3.2.p.13">Alternatively, the derivation scheme above MAY be used to derive a random context identifier (using info = "Context Identifier". In this case key_length SHALL be sufficiently large so that accidental collisions are negligible given the number of security contexts being derived in this way.</p>
<h1 id="rfc.section.4"><a href="#rfc.section.4">4.</a> <a href="#coap-headers-and-options" id="coap-headers-and-options">Protected CoAP Message Fields</a></h1>
<p id="rfc.section.4.p.1">This section defines how the CoAP message fields are protected. OSCOAP protects as much of the unprotected CoAP message as possible, while still allowing forward proxy operations <a href="#I-D.hartke-core-e2e-security-reqs">[I-D.hartke-core-e2e-security-reqs]</a>.</p>
<p id="rfc.section.4.p.2">The CoAP Payload SHALL be encrypted and integrity protected.</p>
<p id="rfc.section.4.p.3">The CoAP Header fields Version and Code SHALL be integrity protected but not encrypted. The CoAP Message Layer parameters, Type and Message ID, as well as Token and Token Length SHALL neither be integrity protected nor encrypted.</p>
<p id="rfc.section.4.p.4">Protection of CoAP Options can be summarized as follows:</p>
<p/>

<ul>
  <li>To prevent information leakage, Uri-Path and Uri-Query SHALL be encrypted. As a consequence, if Proxy-Uri is used, those parts of the URI SHALL be removed from the Proxy-Uri. The CoAP Options Uri-Host, Uri-Port, Proxy-Uri, and Proxy-Scheme SHALL neither be encrypted, nor integrity protected (cf. protection of the effective request URI in <a href="#AAD">Section 5.2</a>).</li>
  <li>The other CoAP options SHALL be encrypted and integrity protected.</li>
</ul>
<p id="rfc.section.4.p.6">A summary of which options are encrypted or integrity protected is shown in <a href="#protected-coap-options">Figure 4</a>.</p>
<div id="rfc.figure.4"/>
<div id="protected-coap-options"/>
<pre>
+----+---+---+---+---+----------------+--------+--------+---+---+---+
| No.| C | U | N | R | Name           | Format | Length | E | I | D |
+----+---+---+---+---+----------------+--------+--------+---+---+---+
|  1 | x |   |   | x | If-Match       | opaque | 0-8    | x | x |   |
|  3 | x | x | - |   | Uri-Host       | string | 1-255  |   |   |   |
|  4 |   |   |   | x | ETag           | opaque | 1-8    | x | x |   |
|  5 | x |   |   |   | If-None-Match  | empty  | 0      | x | x |   |
|  6 |   | x | - |   | Observe        | uint   | 0-3    | x | x | x |
|  7 | x | x | - |   | Uri-Port       | uint   | 0-2    |   |   |   |
|  8 |   |   |   | x | Location-Path  | string | 0-255  | x | x |   |
| 11 | x | x | - | x | Uri-Path       | string | 0-255  | x | x |   |
| 12 |   |   |   |   | Content-Format | uint   | 0-2    | x | x |   |
| 14 |   | x | - |   | Max-Age        | uint   | 0-4    | x | x | x |
| 15 | x | x | - | x | Uri-Query      | string | 0-255  | x | x |   |
| 17 | x |   |   |   | Accept         | uint   | 0-2    | x | x |   |
| 20 |   |   |   | x | Location-Query | string | 0-255  | x | x |   |
| 23 | x | x | - | - | Block2         | uint   | 0-3    | x | x | x |
| 27 | x | x | - | - | Block1         | uint   | 0-3    | x | x | x |
| 28 |   |   | x |   | Size2          | unit   | 0-4    | x | x | x |
| 35 | x | x | - |   | Proxy-Uri      | string | 1-1034 |   |   |   |
| 39 | x | x | - |   | Proxy-Scheme   | string | 1-255  |   |   |   |
| 60 |   |   | x |   | Size1          | uint   | 0-4    | x | x | x |
+----+---+---+---+---+----------------+--------+--------+---+---+---+
         C=Critical, U=Unsafe, N=NoCacheKey, R=Repeatable,
         E=Encrypt, I=Integrity Protect, D=Duplicate.
</pre>
<p class="figure">Figure 4: Protection of CoAP Options</p>
<p id="rfc.section.4.p.7">Unless specified otherwise, CoAP options not listed in <a href="#protected-coap-options">Figure 4</a> SHALL be encrypted and integrity protected.</p>
<p id="rfc.section.4.p.8">Specifications of new CoAP options SHOULD specify how they are processed with OSCOAP. New COAP options SHOULD be encrypted and integrity protected. New COAP options SHALL be integrity protected unless a proxy needs to change the option, and SHALL be encrypted unless a proxy needs to read the option.</p>
<p id="rfc.section.4.p.9">The encrypted options are in general omitted from the protected CoAP message and not visible to intermediary nodes (see <a href="#protected-coap-formatting-req">Section 6.2</a> and <a href="#protected-coap-formatting-resp">Section 6.4</a>). Hence the actions resulting from the use of corresponding options is analogous to the case of communicating directly with the endpoint. For example, a client using an ETag option will not be served by a proxy.</p>
<p id="rfc.section.4.p.10">However, some options which are encrypted need to be present in the protected CoAP message to support certain proxy functions. A CoAP option which may be both encrypted in the COSE object of the protected CoAP message, and also unencrypted as CoAP option in the protected CoAP message, is called "duplicate". The "encrypted" value of a duplicate option is intended for the destination endpoint and the "unencrypted" value is intended for a proxy. The unencrypted value is not integrity protected.</p>
<p/>

<ul>
  <li>The Max-Age option is duplicate. The unencrypted Max-Age SHOULD have value zero to prevent caching of responses. The encrypted Max-Age is used as defined in <a href="#RFC7252">[RFC7252]</a> taking into account that it is not accessible to proxies.</li>
  <li>The Observe option is duplicate. If used, then the encrypted Observe and the unencrypted Observe SHALL have the same value. The Observe option as used here targets the requirements on forwarding of <a href="#I-D.hartke-core-e2e-security-reqs">[I-D.hartke-core-e2e-security-reqs]</a> (Section 2.2.1.2).</li>
  <li>The block options Block1 and Block2 are duplicate. The encrypted block options enable end-to-end secure fragmentation of payload into blocks and protected information about the fragmentation (block number, last block, etc.) such that each block in ordered sequence from the first block can be verified as it arrives. The unencrypted block option allows for arbitrary proxy fragmentation operations which cannot be verified by the endpoints. An intermediary node can generate an arbitrarily long sequence of blocks. However, since it is possible to protect fragmentation of large messages, there SHALL be a security policy defining a maximum unfragmented message size such that messages exceeding this size SHALL be fragmented by the sending endpoint. Hence an endpoint receiving fragments of a message that exceeds maximum message size SHALL discard this message.</li>
  <li>The size options Size1 and Size2 are duplicate, analogously to the block options.</li>
</ul>
<p id="rfc.section.4.p.12">Specifications of new CoAP options SHALL define if the new option is duplicate and how it is processed with OSCOAP. New COAP options SHOULD NOT be duplicate.</p>
<h1 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#sec-obj-cose" id="sec-obj-cose">The COSE Object</a></h1>
<p id="rfc.section.5.p.1">This section defines how to use the COSE format <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a> to wrap and protect data in the unprotected CoAP message. OSCOAP uses the COSE_Encrypt0 structure with an Authenticated Encryption with Additional Data (AEAD) algorithm.</p>
<p id="rfc.section.5.p.2">The mandatory to support AEAD algorithm is AES-CCM-64-64-128 defined in Section 10.2 of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>. For AES-CCM-64-64-128 the length of Sender Key and Recipient Key SHALL be 128 bits, the length of IV, Sender IV, and Recipient IV SHALL be 7 bytes, and the maximum Sender Sequence Number and Recipient Sequence Number SHALL be 2^56-1. The IV is constructed using a Partial Initialization Vector exactly like in Section 3.1 of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>, i.e. by padding the Sender Sequence Number or the Recipient Sequence Number with zeroes and XORing it with the static Sender IV or Recipient IV, respectively.</p>
<p id="rfc.section.5.p.3">Since OSCOAP only makes use of a single COSE structure, there is no need to explicitly specify the structure, and OSCOAP uses the untagged version of the COSE_Encrypt0 structure (Section 2. of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>). If the COSE object has a different structure, the recipient MUST reject the message, treating it as malformed.</p>
<p id="rfc.section.5.p.4">We denote by Plaintext the data that is encrypted and integrity protected, and by Additional Authenticated Data (AAD) the data that is integrity protected only, in the COSE object.</p>
<p id="rfc.section.5.p.5">The fields of COSE_Encrypt0 structure are defined as follows (see example in <a href="#sem-auth-enc">Appendix C.4</a>).</p>
<p/>

<ul>
  <li>The "Headers" field is formed by:  <ul><li>The "protected" field, which SHALL include:      <ul><li>The "Partial Initialization Vector" parameter. The value is set to the Sender Sequence Number. The Partial IV is a byte string (type: bstr), where the length is the minimum length needed to encode the sequence number. An Endpoint that receives a COSE object with a sequence number encoded with leading zeroes (i.e. longer than the minimum needed length) SHALL reject the corresponding message as malformed.</li><li>If the message is a CoAP request, the "kid" parameter. The value is set to the Context Identifier (see <a href="#sec-context-section">Section 3</a>).</li><li>Optionally, the parameter called "sid", defined below. The value is set to the Sender ID (see <a href="#sec-context-section">Section 3</a>).</li></ul></li><li>The "unprotected" field, which SHALL be empty.</li></ul></li>
  <li>The "cipher text" field is computed from the Plaintext (see <a href="#plaintext">Section 5.1</a>) and the Additional Authenticated Data (AAD) (see <a href="#AAD">Section 5.2</a>) and encoded as a byte string (type: bstr), following Section 5.2 of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>.</li>
</ul>
<p/>

<dl>
  <dt>sid:</dt>
  <dd style="margin-left: 8">This parameter is used to identify the sender of the message. Applications MUST NOT assume that 'sid' values are unique. This is not a security critical field. For this reason, it can be placed in the unprotected headers bucket.</dd>
</dl>
<div id="rfc.table.1"/>
<div id="sid-def"/>
<table cellpadding="3" cellspacing="0" class="tt full center">
  <caption>Additional COSE Header Parameter</caption>
  <thead>
    <tr>
      <th class="left">name</th>
      <th class="center">label</th>
      <th class="center">value type</th>
      <th class="left">value registry</th>
      <th class="left">description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class="left">sid</td>
      <td class="center">TBD</td>
      <td class="center">bstr</td>
      <td class="left"/>
      <td class="left">Sender identifier</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.section.5.1"><a href="#rfc.section.5.1">5.1.</a> <a href="#plaintext" id="plaintext">Plaintext</a></h1>
<p id="rfc.section.5.1.p.1">The Plaintext is formatted as a CoAP message without Header (see <a href="#plaintext-figure">Figure 5</a>) consisting of:</p>
<p/>

<ul>
  <li>all CoAP Options present in the unprotected message which are encrypted (see <a href="#coap-headers-and-options">Section 4</a>), in the order as given by the Option number (each Option with Option Header including delta to previous included encrypted option); and</li>
  <li>the CoAP Payload, if present, and in that case prefixed by the one-byte Payload Marker (0xFF).</li>
</ul>
<div id="rfc.figure.5"/>
<div id="plaintext-figure"/>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Options to Encrypt (if any) ...                            ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1 1 1 1 1 1 1 1|    Payload (if any) ...                       ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 (only if there 
   is payload)
</pre>
<p class="figure">Figure 5: Plaintext</p>
<h1 id="rfc.section.5.2"><a href="#rfc.section.5.2">5.2.</a> <a href="#AAD" id="AAD">Additional Authenticated Data</a></h1>
<p id="rfc.section.5.2.p.1">The Additional Authenticated Data ("Enc_structure") as described is Section 5.3 of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a> includes (see <a href="#aad-enc-figure">Figure 6</a>):</p>
<p/>

<ul>
  <li>the "context" parameter, which has value "Encrypted"</li>
  <li>the "protected" parameter, which includes the "protected" part of the "Headers" field;</li>
  <li>the "external_aad" includes, in the given order:  <ul><li>the CoAP version number and Code of the message formatted as two bytes: the first 2 digits in the first byte indicate the version number, the other digits are set to 0, the second byte indicates the Code (see <a href="#aad-enc-figure">Figure 6</a>). This corresponds to the first two bytes of the CoAP header in the unprotected message with Type and Token Length bits set to 0 in the case of CoAP over UDP. In the case of CoAP over TCP, even though the CoAP message format is different (see <a href="#I-D.ietf-core-coap-tcp-tls">[I-D.ietf-core-coap-tcp-tls]</a>), the version number and Code are still included in the external_aad formatted as indicated above;</li><li>The Algorithm from the security context used for the exchange;</li><li>the plaintext "effective" request URI composed from the request scheme and Uri-* options according to the method described in Section 6.5 of <a href="#RFC7252">[RFC7252]</a>, if the message is a CoAP request;</li><li>the Transaction Identifier (Tid) of the associated CoAP request, if the message is a CoAP response (see <a href="#sec-context-section">Section 3</a>), and</li><li>the MAC of the message containing the previous block in the sequence, as enumerated by Block1 in the case of a request and Block2 in the case of a response, if the message is fragmented using a block option <a href="#I-D.ietf-core-block">[I-D.ietf-core-block]</a>.</li></ul></li>
</ul>
<div id="rfc.figure.6"/>
<div id="aad-enc-figure"/>
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Ver|0 0 0 0 0 0|      Code     |      Alg      |      ...      ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
~   request URI (if request) / request Tid (if response)        ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
~   MAC of previous block (if Block1 or Block2 present)         ~
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p class="figure">Figure 6: Additional Authenticated Data</p>
<p id="rfc.section.5.2.p.3">The encryption process is described in Section 5.3 of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>.</p>
<h1 id="rfc.section.6"><a href="#rfc.section.6">6.</a> <a href="#coap-protected-generate" id="coap-protected-generate">Protecting CoAP Messages</a></h1>
<h1 id="rfc.section.6.1"><a href="#rfc.section.6.1">6.1.</a> <a href="#replay-protection-section" id="replay-protection-section">Replay and Freshness Protection</a></h1>
<p id="rfc.section.6.1.p.1">In order to protect from replay of messages and verify freshness, a CoAP endpoint SHALL maintain a Sender Sequence Number, and a Recipient Sequence Number associated to a security context, which is identified with a Context Identifier (Cid). The two sequence numbers are the highest sequence number the endpoint has sent and the highest sequence number the endpoint has received. An endpoint uses the Sender Sequence Number to protect messages to send and the Recipient Sequence Number to verify received messages, as described in <a href="#sec-context-section">Section 3</a>.</p>
<p id="rfc.section.6.1.p.2">Depending on use case and ordering of messages provided by underlying layers, an endpoint MAY maintain a sliding replay window for Sequence Numbers of received messages associated to each Cid. In case of reliable transport, the receiving endpoint MAY require that the Sequence Number of a received message equals last Sequence Number + 1.</p>
<p id="rfc.section.6.1.p.3">A receiving endpoint SHALL verify that the Sequence Number received in the COSE object has not been received before in the security context identified by the Cid. The receiving endpoint SHALL also reject messages with a sequence number greater than 2^56-1.</p>
<p id="rfc.section.6.1.p.4">OSCOAP is a challenge-response protocol, where the response is verified to match a prior request, by including the unique transaction identifier (Tid as defined in <a href="#sec-context-section">Section 3</a>) of the request in the Additional Authenticated Data of the response message.</p>
<p id="rfc.section.6.1.p.5">If a CoAP server receives a request with the Object-Security option, then the server SHALL include the Tid of the request in the AAD of the response, as described in <a href="#protected-coap-formatting-resp">Section 6.4</a>.</p>
<p id="rfc.section.6.1.p.6">If the CoAP client receives a response with the Object-Security option, then the client SHALL verify the integrity of the response, using the Tid of its own associated request in the AAD, as described in <a href="#verif-coap-resp">Section 6.5</a>.</p>
<h1 id="rfc.section.6.2"><a href="#rfc.section.6.2">6.2.</a> <a href="#protected-coap-formatting-req" id="protected-coap-formatting-req">Protecting the Request</a></h1>
<p id="rfc.section.6.2.p.1">Given an unprotected CoAP request, including header, options and payload, the client SHALL perform the following steps to create a protected CoAP request using a security context associated with the target resource:</p>
<p/>

<ol>
  <li>Increment the Sender Sequence Number by one (note that this means that sequence number 0 is never used). If the Sender Sequence Number exceeds the maximum number for the AEAD algorithm, the client MUST NOT process any requests with the given security context. The client SHOULD acquire a new security context (and consequently inform the server about it) before this happens. The latter is out of scope of this memo.</li>
  <li>Compute the COSE object as specified in <a href="#sec-obj-cose">Section 5</a>  <ul><li>the IV in the AEAD is created by XORing the static IV (Sender IV) with the partial IV (Sender Sequence Number).</li><li>If the block option is used, the AAD includes the MAC from the previous fragment sent (from the second fragment and following) <a href="#AAD">Section 5.2</a>. This means that the endpoint MUST store the MAC of each last-sent fragment to compute the following.</li></ul></li>
  <li>Format the protected CoAP message as an ordinary CoAP message, with the following Header, Options, and Payload, based on the unprotected CoAP message:  <ul><li>The CoAP header is the same as the unprotected CoAP message.</li><li>The CoAP options which are encrypted and not duplicate (<a href="#coap-headers-and-options">Section 4</a>) are removed. Any duplicate option which is present has its unencrypted value. The Object-Security option is added.</li><li>If the unprotected CoAP message has no Payload, then the value of the Object-Security option is the COSE object. If the unprotected CoAP message has Payload, then the Object-Security option is empty and the Payload of the protected CoAP message is the COSE object.</li></ul></li>
</ol>
<p id="rfc.section.6.2.p.3">The Client SHALL be able to find the correct security context with use of the Token of the message exchange.</p>
<h1 id="rfc.section.6.3"><a href="#rfc.section.6.3">6.3.</a> <a href="#verif-coap-req" id="verif-coap-req">Verifying the Request</a></h1>
<p id="rfc.section.6.3.p.1">A CoAP server receiving a message containing the Object-Security option SHALL perform the following steps, using the security context identified by the Context Identifier in the "kid" parameter in the received COSE object:</p>
<p/>

<ol>
  <li>Verify the Sequence Number in the Partial IV parameter, as described in <a href="#replay-protection-section">Section 6.1</a>. If it cannot be verified that the Sequence Number has not been received before, the server MUST stop processing the request.</li>
  <li>Recreate the Additional Authenticated Data, as described in <a href="#sec-obj-cose">Section 5</a>.  <ul><li>If the block option is used, the AAD includes the MAC from the previous fragment received (from the second fragment and following) <a href="#AAD">Section 5.2</a>. This means that the endpoint MUST store the MAC of each last-received fragment to compute the following.</li></ul></li>
  <li>Compose the IV by XORing the static IV (Recipient IV) with the Partial IV parameter, received in the COSE Object.</li>
  <li>Retrieve the Recipient Key.</li>
  <li>Verify and decrypt the message. If the verification fails, the server MUST stop processing the request.</li>
  <li>If the message verifies, update the Recipient Sequence Number or Replay Window, as described in <a href="#replay-protection-section">Section 6.1</a>.</li>
  <li>Restore the unprotected request by adding any decrypted options or payload from the plaintext. Any duplicate options (<a href="#coap-headers-and-options">Section 4</a>) are overwritten. The Object-Security option is removed.</li>
</ol>
<h1 id="rfc.section.6.4"><a href="#rfc.section.6.4">6.4.</a> <a href="#protected-coap-formatting-resp" id="protected-coap-formatting-resp">Protecting the Response</a></h1>
<p id="rfc.section.6.4.p.1">A server receiving a valid request with a protected CoAP message (i.e. containing an Object-Security option) SHALL respond with a protected CoAP message.</p>
<p id="rfc.section.6.4.p.2">Given an unprotected CoAP response, including header, options, and payload, the server SHALL perform the following steps to create a protected CoAP response, using the security context identified by the Context Identifier of the received request:</p>
<p/>

<ol>
  <li>Increment the Sender Sequence Number by one (note that this means that sequence number 0 is never used). If the Sender Sequence Number exceeds the maximum number for the AEAD algorithm, the server MUST NOT process any more responses with the given security context. The server SHOULD acquire a new security context (and consequently inform the client about it) before this happens. The latter is out of scope of this memo.</li>
  <li>Compute the COSE object as specified in Section <a href="#sec-obj-cose">Section 5</a> <ul><li>The IV in the AEAD is created by XORing the static IV (Sender IV) and the Sender Sequence Number.</li><li>If the block option is used, the AAD includes the MAC from the previous fragment sent (from the second fragment and following) <a href="#AAD">Section 5.2</a>. This means that the endpoint MUST store the MAC of each last-sent fragment to compute the following.</li></ul></li>
  <li>Format the protected CoAP message as an ordinary CoAP message, with the following Header, Options, and Payload based on the unprotected CoAP message: <ul><li>The CoAP header is the same as the unprotected CoAP message.</li><li>The CoAP options which are encrypted and not duplicate (<a href="#coap-headers-and-options">Section 4</a>) are removed. Any duplicate option which is present has its unencrypted value. The Object-Security option is added.</li><li>If the unprotected CoAP message has no Payload, then the value of the Object-Security option is the COSE object. If the unprotected CoAP message has Payload, then the Object-Security option is empty, and the Payload of the protected CoAP message is the COSE object.</li></ul></li>
</ol>
<p id="rfc.section.6.4.p.4">Note the differences between generating a protected request, and a protected response, for example whether "kid" is present in the header, or whether Destination URI or Tid is present in the AAD, of the COSE object.</p>
<h1 id="rfc.section.6.5"><a href="#rfc.section.6.5">6.5.</a> <a href="#verif-coap-resp" id="verif-coap-resp">Verifying the Response</a></h1>
<p id="rfc.section.6.5.p.1">A CoAP client receiving a message containing the Object-Security option SHALL perform the following steps, using the security context identified by the Token of the received response:</p>
<p/>

<ol>
  <li>Verify the Sequence Number in the Partial IV parameter as described in <a href="#replay-protection-section">Section 6.1</a>. If it cannot be verified that the Sequence Number has not been received before, the client MUST stop processing the response.</li>
  <li>Recreate the Additional Authenticated Data as described in <a href="#sec-obj-cose">Section 5</a>.  <ul><li>If the block option is used, the AAD includes the MAC from the previous fragment received (from the second fragment and following) <a href="#AAD">Section 5.2</a>. This means that the endpoint MUST store the MAC of each last-received fragment to compute the following.</li></ul></li>
  <li>Compose the IV by XORing the static IV (Recipient IV) with the Partial IV parameter, received in the COSE Object.</li>
  <li>Retrieve the Recipient Key.</li>
  <li>Verify and decrypt the message. If the verification fails, the client MUST stop processing the response.</li>
  <li>If the message verifies, update the Recipient Sequence Number or Replay Window, as described in <a href="#replay-protection-section">Section 6.1</a>.</li>
  <li>Restore the unprotected response by adding any decrypted options or payload from the plaintext. Any duplicate options (<a href="#coap-headers-and-options">Section 4</a>) are overwritten. The Object-Security option is removed.</li>
</ol>
<h1 id="rfc.section.7"><a href="#rfc.section.7">7.</a> <a href="#sec-considerations" id="sec-considerations">Security Considerations</a></h1>
<p id="rfc.section.7.p.1">In scenarios with intermediary nodes such as proxies or brokers, transport layer security such as DTLS only protects data hop-by-hop. As a consequence the intermediary nodes can read and modify information. The trust model where all intermediate nodes are considered trustworthy is problematic, not only from a privacy perspective, but also from a security perspective, as the intermediaries are free to delete resources on sensors and falsify commands to actuators (such as "unlock door", "start fire alarm", "raise bridge"). Even in the rare cases, where all the owners of the intermediary nodes are fully trusted, attacks and data breaches make such an architecture brittle.</p>
<p id="rfc.section.7.p.2">DTLS protects hop-by-hop the entire CoAP message, including header, options, and payload. OSCOAP protects end-to-end the payload, and all information in the options and header, that is not required for forwarding (see <a href="#coap-headers-and-options">Section 4</a>). DTLS and OSCOAP can be combined, thereby enabling end-to-end security of CoAP payload, in combination with hop-by-hop protection of the entire CoAP message, during transport between end-point and intermediary node.</p>
<p id="rfc.section.7.p.3">The CoAP message layer, however, cannot be protected end-to-end through intermediary devices since the parameters Type and Message ID, as well as Token and Token Length may be changed by a proxy. Moreover, messages that are not possible to verify should for security reasons not always be acknowledged but in some cases be silently dropped. This would not comply with CoAP message layer, but does not have an impact on the application layer security solution, since message layer is excluded from that.</p>
<p id="rfc.section.7.p.4">The use of COSE to protect CoAP messages as specified in this document requires an established security context. The method to establish the security context described in <a href="#sec-context-est-section">Section 3.2</a> is based on a common keying material and key derivation function in client and server. EDHOC <a href="#I-D.selander-ace-cose-ecdhe">[I-D.selander-ace-cose-ecdhe]</a> describes an augmented Diffie-Hellman key exchange to produce forward secret keying material and agree on crypto algorithms necessary for OSCOAP, authenticated with pre-established credentials. These pre-established credentials may, in turn, be provisioned using a trusted third party such as described in the OAuth-based ACE framework <a href="#I-D.ietf-ace-oauth-authz">[I-D.ietf-ace-oauth-authz]</a>. An OSCOAP profile of ACE is described in <a href="#I-D.seitz-ace-oscoap-profile">[I-D.seitz-ace-oscoap-profile]</a>.</p>
<p id="rfc.section.7.p.5">For symmetric encryption it is required to have a unique IV for each message, for which the sequence numbers in the COSE message field "Partial IV" is used. The static IVs (Sender IV and Recipient IV) SHOULD be established between sender and recipient before the message is sent, for example using the method in <a href="#I-D.selander-ace-cose-ecdhe">[I-D.selander-ace-cose-ecdhe]</a>, to avoid the overhead of sending it in each message.</p>
<p id="rfc.section.7.p.6">If the recipient accepts any sequence number larger than the one previously received, the problem of sequence number synchronization is avoided. (With reliable transport it may be defined that only messages with sequence number which are equal to previous sequence number + 1 are accepted.) The alternatives to sequence numbers have their issues: very constrained devices may not be able to support accurate time, or to generate and store large numbers of random IVs. The requirement to change key at counter wrap is a complication, but it also forces the user of this specification to think about implementing key renewal.</p>
<p id="rfc.section.7.p.7">The encrypted block options enable the sender to split large messages into protected fragments such that the receiving node can verify blocks before having received the complete message. In order to protect from attacks replacing fragments from a different message with the same block number between same endpoints and same resource at roughly the same time, the MAC from the message containing one block is included in the external_aad of the message containing the next block.</p>
<p id="rfc.section.7.p.8">The unencrypted block options allow for arbitrary proxy fragmentation operations which cannot be verified by the endpoints, but can by policy be restricted in size since the encrypted options allow for secure fragmentation of very large messages. A maximum message size (above which the sending endpoint fragments the message and the receiving endpoint discards the message, if complying to the policy) may be obtained as part of normal resource discovery.</p>
<h1 id="rfc.section.8"><a href="#rfc.section.8">8.</a> <a href="#privacy-considerations" id="privacy-considerations">Privacy Considerations</a></h1>
<p id="rfc.section.8.p.1">Privacy threats executed through intermediate nodes are considerably reduced by means of OSCOAP. End-to-end integrity protection and encryption of CoAP payload and all options that are not used for forwarding, provide mitigation against attacks on sensor and actuator communication, which may have a direct impact on the personal sphere.</p>
<p id="rfc.section.8.p.2">CoAP headers sent in plaintext allow for example matching of CON and ACK (CoAP Message Identifier), matching of request and responses (Token) and traffic analysis.</p>
<h1 id="rfc.section.9"><a href="#rfc.section.9">9.</a> <a href="#iana" id="iana">IANA Considerations</a></h1>
<p id="rfc.section.9.p.1">Note to RFC Editor: Please replace all occurrences of "[[this document]]" with the RFC number of this specification.</p>
<h1 id="rfc.section.9.1"><a href="#rfc.section.9.1">9.1.</a> <a href="#sid-registration" id="sid-registration">Sid Registration</a></h1>
<p id="rfc.section.9.1.p.1">IANA is requested to enter a new parameter entitled "sid" to the registry "COSE Header Parameters". The parameter is defined in <a href="#sid-def">Table 1</a>.</p>
<h1 id="rfc.section.9.2"><a href="#rfc.section.9.2">9.2.</a> <a href="#coap-option-number-registration" id="coap-option-number-registration">CoAP Option Number Registration</a></h1>
<p id="rfc.section.9.2.p.1">The Object-Security option is added to the CoAP Option Numbers registry:</p>
<pre>
+--------+-----------------+-------------------+
| Number | Name            | Reference         |
+--------+-----------------+-------------------+
|  TBD   | Object-Security | [[this document]] |
+--------+-----------------+-------------------+
</pre>
<h1 id="rfc.section.9.3"><a href="#rfc.section.9.3">9.3.</a> <a href="#media-type-registrations" id="media-type-registrations">Media Type Registrations</a></h1>
<p id="rfc.section.9.3.p.1">The "application/oscon" media type is added to the Media Types registry:</p>
<pre>
    Type name: application

    Subtype name: cose

    Required parameters: N/A

    Optional parameters: N/A

    Encoding considerations: binary

    Security considerations: See the Security Considerations section
    of [[this document]].

    Interoperability considerations: N/A

    Published specification: [[this document]]

    Applications that use this media type: To be identified

    Fragment identifier considerations: N/A

    Additional information:

    * Magic number(s): N/A

    * File extension(s): N/A

    * Macintosh file type code(s): N/A

    Person &amp; email address to contact for further information:
    iesg@ietf.org

    Intended usage: COMMON

    Restrictions on usage: N/A

    Author: Goeran Selander, goran.selander@ericsson.com

    Change Controller: IESG

    Provisional registration? No
</pre>
<h1 id="rfc.section.9.4"><a href="#rfc.section.9.4">9.4.</a> <a href="#coap-content-format-registration" id="coap-content-format-registration">CoAP Content Format Registration</a></h1>
<p id="rfc.section.9.4.p.1">The "application/oscon" content format is added to the CoAP Content Format registry:</p>
<pre>
+-------------------+----------+----+-------------------+
| Media type        | Encoding | ID | Reference         |
+-------------------+----------+----+-------------------+
| application/oscon | -        | 70 | [[this document]] |
+-------------------+----------+----+-------------------+
</pre>
<h1 id="rfc.section.10"><a href="#rfc.section.10">10.</a> <a href="#acknowledgments" id="acknowledgments">Acknowledgments</a></h1>
<p id="rfc.section.10.p.1">Klaus Hartke has independently been working on the same problem and a similar solution: establishing end-to-end security across proxies by adding a CoAP option. We are grateful to Malisa Vucinic and Marco Tiloca for providing helpful and timely reviews of previous versions of the draft. We are also grateful to Carsten Bormann and Jim Schaad for providing input and interesting discussions.</p>
<h1 id="rfc.references"><a href="#rfc.references">11.</a> References</h1>
<h1 id="rfc.references.1"><a href="#rfc.references.1">11.1.</a> Normative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</b>
      </td>
      <td class="top"><a>Schaad, J.</a>, "<a href="http://tools.ietf.org/html/draft-ietf-cose-msg-18">CBOR Object Signing and Encryption (COSE)</a>", Internet-Draft draft-ietf-cose-msg-18, September 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC2119">[RFC2119]</b>
      </td>
      <td class="top"><a>Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC6347">[RFC6347]</b>
      </td>
      <td class="top"><a>Rescorla, E.</a> and <a>N. Modadugu</a>, "<a href="http://tools.ietf.org/html/rfc6347">Datagram Transport Layer Security Version 1.2</a>", RFC 6347, DOI 10.17487/RFC6347, January 2012.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7252">[RFC7252]</b>
      </td>
      <td class="top"><a>Shelby, Z.</a>, <a>Hartke, K.</a> and <a>C. Bormann</a>, "<a href="http://tools.ietf.org/html/rfc7252">The Constrained Application Protocol (CoAP)</a>", RFC 7252, DOI 10.17487/RFC7252, June 2014.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7641">[RFC7641]</b>
      </td>
      <td class="top"><a>Hartke, K.</a>, "<a href="http://tools.ietf.org/html/rfc7641">Observing Resources in the Constrained Application Protocol (CoAP)</a>", RFC 7641, DOI 10.17487/RFC7641, September 2015.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.references.2"><a href="#rfc.references.2">11.2.</a> Informative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="I-D.bormann-6lo-coap-802-15-ie">[I-D.bormann-6lo-coap-802-15-ie]</b>
      </td>
      <td class="top"><a>Bormann, C.</a>, "<a href="http://tools.ietf.org/html/draft-bormann-6lo-coap-802-15-ie-00">Constrained Application Protocol (CoAP) over IEEE 802.15.4 Information Element for IETF</a>", Internet-Draft draft-bormann-6lo-coap-802-15-ie-00, April 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.hartke-core-e2e-security-reqs">[I-D.hartke-core-e2e-security-reqs]</b>
      </td>
      <td class="top"><a>Selander, G.</a>, <a>Palombini, F.</a> and <a>K. Hartke</a>, "<a href="http://tools.ietf.org/html/draft-hartke-core-e2e-security-reqs-01">Requirements for CoAP End-To-End Security</a>", Internet-Draft draft-hartke-core-e2e-security-reqs-01, July 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.ietf-ace-oauth-authz">[I-D.ietf-ace-oauth-authz]</b>
      </td>
      <td class="top"><a>Seitz, L.</a>, <a>Selander, G.</a>, <a>Wahlstroem, E.</a>, <a>Erdtman, S.</a> and <a>H. Tschofenig</a>, "<a href="http://tools.ietf.org/html/draft-ietf-ace-oauth-authz-02">Authentication and Authorization for Constrained Environments (ACE)</a>", Internet-Draft draft-ietf-ace-oauth-authz-02, June 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.ietf-core-block">[I-D.ietf-core-block]</b>
      </td>
      <td class="top"><a>Bormann, C.</a> and <a>Z. Shelby</a>, "<a href="http://tools.ietf.org/html/draft-ietf-core-block-21">Block-wise transfers in CoAP</a>", Internet-Draft draft-ietf-core-block-21, July 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.ietf-core-coap-tcp-tls">[I-D.ietf-core-coap-tcp-tls]</b>
      </td>
      <td class="top"><a>Bormann, C.</a>, <a>Lemay, S.</a>, <a>Tschofenig, H.</a>, <a>Hartke, K.</a>, <a>Silverajan, B.</a> and <a>B. Raymor</a>, "<a href="http://tools.ietf.org/html/draft-ietf-core-coap-tcp-tls-04">CoAP (Constrained Application Protocol) over TCP, TLS, and WebSockets</a>", Internet-Draft draft-ietf-core-coap-tcp-tls-04, August 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.seitz-ace-oscoap-profile">[I-D.seitz-ace-oscoap-profile]</b>
      </td>
      <td class="top"><a>Seitz, L.</a>, "<a href="http://tools.ietf.org/html/draft-seitz-ace-oscoap-profile-00">OSCOAP profile of ACE</a>", Internet-Draft draft-seitz-ace-oscoap-profile-00, July 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="I-D.selander-ace-cose-ecdhe">[I-D.selander-ace-cose-ecdhe]</b>
      </td>
      <td class="top"><a>Selander, G.</a>, <a>Mattsson, J.</a> and <a>F. Palombini</a>, "<a href="http://tools.ietf.org/html/draft-selander-ace-cose-ecdhe-02">Ephemeral Diffie-Hellman Over COSE (EDHOC)</a>", Internet-Draft draft-selander-ace-cose-ecdhe-02, July 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5869">[RFC5869]</b>
      </td>
      <td class="top"><a>Krawczyk, H.</a> and <a>P. Eronen</a>, "<a href="http://tools.ietf.org/html/rfc5869">HMAC-based Extract-and-Expand Key Derivation Function (HKDF)</a>", RFC 5869, DOI 10.17487/RFC5869, May 2010.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7228">[RFC7228]</b>
      </td>
      <td class="top"><a>Bormann, C.</a>, <a>Ersue, M.</a> and <a>A. Keranen</a>, "<a href="http://tools.ietf.org/html/rfc7228">Terminology for Constrained-Node Networks</a>", RFC 7228, DOI 10.17487/RFC7228, May 2014.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.appendix.A"><a href="#rfc.appendix.A">Appendix A.</a> <a href="#appendix-a" id="appendix-a">Overhead</a></h1>
<p id="rfc.section.A.p.1">OSCOAP transforms an unprotected CoAP message to a protected CoAP message, and the protected CoAP message is larger than the unprotected CoAP message. This appendix illustrates the message expansion.</p>
<h1 id="rfc.appendix.A.1"><a href="#rfc.appendix.A.1">A.1.</a> <a href="#appendix-a1" id="appendix-a1">Length of the Object-Security Option</a></h1>
<p id="rfc.section.A.1.p.1">The protected CoAP message contains the COSE object. The COSE object is included in the payload if the unprotected CoAP message has payload or else in the Object-Security option. In the former case the Object-Security option is empty. So the length of the Object-Security option is either zero or the size of the COSE object, depending on whether the CoAP message has payload or not.</p>
<p id="rfc.section.A.1.p.2">Length of Object-Security option = { 0, size of COSE Object }</p>
<h1 id="rfc.appendix.A.2"><a href="#rfc.appendix.A.2">A.2.</a> <a href="#appendix-a2" id="appendix-a2">Size of the COSE Object</a></h1>
<p id="rfc.section.A.2.p.1">The size of the COSE object is the sum of the sizes of</p>
<p/>

<ul>
  <li>the Header parameters,</li>
  <li>the Cipher Text (excluding the Tag),</li>
  <li>the Tag, and</li>
  <li>data incurred by the COSE format itself (including CBOR encoding).</li>
</ul>
<p id="rfc.section.A.2.p.3">Let's analyse the contributions one at a time:</p>
<p/>

<ul>
  <li>The header parameters of the COSE object are the Context Identifier (Cid) and the Sequence Number (Seq) (also known as the Transaction Identifier (Tid)) if the message is a request, and Seq only if the message is a response (see <a href="#sec-obj-cose">Section 5</a>).  <ul><li>The size of Cid depends on the number of simultaneous clients, as discussed in <a href="#sec-context-est-section">Section 3.2</a></li><li>The size of Seq is variable, and increases with the number of messages exchanged.</li><li>As the IV is generated from the padded Sequence Number and a previously agreed upon static IV it is not required to send the whole IV in the message.</li></ul></li>
  <li>The Cipher Text, excluding the Tag, is the encryption of the payload and the encrypted options <a href="#coap-headers-and-options">Section 4</a>, which are present in the unprotected CoAP message.</li>
  <li>The size of the Tag depends on the Algorithm. For the OSCOAP mandatory algorithm AES-CCM-64-64-128, the Tag is 8 bytes.</li>
  <li>The overhead from the COSE format itself depends on the sizes of the previous fields, and is of the order of 10 bytes.</li>
</ul>
<h1 id="rfc.appendix.A.3"><a href="#rfc.appendix.A.3">A.3.</a> <a href="#appendix-a3" id="appendix-a3">Message Expansion</a></h1>
<p id="rfc.section.A.3.p.1">The message expansion is not the size of the COSE object. The cipher text in the COSE object is encrypted payload and options of the unprotected CoAP message - the plaintext of which is removed from the protected CoAP message. Since the size of the cipher text is the same as the corresponding plaintext, there is no message expansion due to encryption; payload and options are just represented in a different way in the protected CoAP message:</p>
<p/>

<ul>
  <li>The encrypted payload is in the payload of the protected CoAP message</li>
  <li>The encrypted options are in the Object-Security option or within the payload.</li>
</ul>
<p id="rfc.section.A.3.p.3">Therefore the OSCOAP message expansion is due to Cid (if present), Seq, Tag, and COSE overhead:</p>
<div id="rfc.figure.7"/>
<div id="mess-exp-formula"/>
<pre>
Message Overhead = Cid + Seq + Tag + COSE Overhead
</pre>
<p class="figure">Figure 7: OSCOAP message expansion</p>
<h1 id="rfc.appendix.A.4"><a href="#rfc.appendix.A.4">A.4.</a> <a href="#appendix-b" id="appendix-b">Example</a></h1>
<p id="rfc.section.A.4.p.1">This section gives an example of message expansion in a request with OSCOAP.</p>
<p id="rfc.section.A.4.p.2">In this example we assume an extreme 4-byte Cid, based on the assumption of an ACE deployment with billions of clients requesting access to this particular server. (A typical Cid, will be 1-2 byte as is discussed in <a href="#appendix-a2">Appendix A.2</a>.)</p>
<p/>

<ul>
  <li>Cid: 0xa1534e3c</li>
</ul>
<p id="rfc.section.A.4.p.4">In the example the sequence number is 225, requiring 1 byte to encode. (The size of Seq could be larger depending on how many messages that has been sent as is discussed in <a href="#appendix-a2">Appendix A.2</a>.)</p>
<p/>

<ul>
  <li>Seq: 225</li>
</ul>
<p id="rfc.section.A.4.p.6">The example is based on AES-CCM-64-64-128.</p>
<p/>

<ul>
  <li>Tag is 8 bytes</li>
</ul>
<p id="rfc.section.A.4.p.8">The COSE object is represented in <a href="#mess-exp-ex">Figure 8</a> using CBOR's diagnostic notation.</p>
<div id="rfc.figure.8"/>
<div id="mess-exp-ex"/>
<pre>
[
  h'a20444a1534e3c0641e2', # protected:
                             {04:h'a1534e3c',
                              06:h'e2'}
  {},                      # unprotected: -
  Tag                      # cipher text + 8 byte authentication tag
]
</pre>
<p class="figure">Figure 8: Example of message expansion</p>
<p id="rfc.section.A.4.p.9">Note that the encrypted CoAP options and payload are omitted since we target the message expansion (see <a href="#appendix-a3">Appendix A.3</a>). Therefore the size of the COSE Cipher Text equals the size of the Tag, which is 8 bytes.</p>
<p id="rfc.section.A.4.p.10">The COSE object encodes to a total size of 22 bytes, which is the message expansion in this example. The COSE overhead in this example is 22 - (4 + 1 + 8) = 9 bytes, according to the formula in <a href="#mess-exp-formula">Figure 7</a>. Note that in this example two bytes in the COSE overhead are used to encode the length of Cid and the length of Seq.</p>
<p><a href="#table-aes-ccm">Figure 9</a> summarizes these results.</p>
<div id="rfc.figure.9"/>
<div id="table-aes-ccm"/>
<pre>
+---------+---------+----------+------------+
|   Tid   |   Tag   | COSE OH  | Message OH |
+---------+---------+----------+------------+
| 5 bytes | 8 bytes |  9 bytes |  22 bytes  |
+---------+---------+----------+------------+
</pre>
<p class="figure">Figure 9: Message overhead for a 5-byte Tid and 8-byte Tag.</p>
<h1 id="rfc.appendix.B"><a href="#rfc.appendix.B">Appendix B.</a> <a href="#appendix-d" id="appendix-d">Examples</a></h1>
<p id="rfc.section.B.p.1">This section gives examples of OSCOAP. The message exchanges are made, based on the assumption that there is a security context established between client and server. For simplicity, these examples only indicate the content of the messages without going into detail of the COSE message format.</p>
<h1 id="rfc.appendix.B.1"><a href="#rfc.appendix.B.1">B.1.</a> <a href="#secure-access-to-sensor" id="secure-access-to-sensor">Secure Access to Sensor</a></h1>
<p id="rfc.section.B.1.p.1">Here is an example targeting the scenario in the Section 2.2.1. - Forwarding of <a href="#I-D.hartke-core-e2e-security-reqs">[I-D.hartke-core-e2e-security-reqs]</a>. The example illustrates a client requesting the alarm status from a server. In the request, CoAP option Uri-Path is encrypted and integrity protected, and the CoAP header fields Code and Version are integrity protected (see <a href="#coap-headers-and-options">Section 4</a>). In the response, the CoAP Payload is encrypted and integrity protected, and the CoAP header fields Code and Version are integrity protected.</p>
<div id="rfc.figure.10"/>
<div id="get-protected-sig"/>
<pre>
Client  Proxy  Server
   |      |      |
   +-----&gt;|      |            Code: 0.01 (GET)
   | GET  |      |           Token: 0x8c
   |      |      | Object-Security: [cid:5fdc, seq:42,
   |      |      |                   {Uri-Path:"alarm_status"},
   |      |      |                   &lt;Tag&gt;]
   |      |      |         Payload: -
   |      |      |
   |      +-----&gt;|            Code: 0.01 (GET)
   |      | GET  |           Token: 0x7b
   |      |      | Object-Security: [cid:5fdc, seq:42,
   |      |      |                   {Uri-Path:"alarm_status"},
   |      |      |                   &lt;Tag&gt;]
   |      |      |         Payload: -
   |      |      |
   |      |&lt;-----+            Code: 2.05 (Content)
   |      | 2.05 |           Token: 0x7b
   |      |      |         Max-Age: 0
   |      |      | Object-Security: -
   |      |      |         Payload: [seq:56, {"OFF"}, &lt;Tag&gt;]
   |      |      |
   |&lt;-----+      |            Code: 2.05 (Content)
   | 2.05 |      |           Token: 0x8c
   |      |      |         Max-Age: 0
   |      |      | Object-Security: -
   |      |      |         Payload: [seq:56, {"OFF"}, &lt;Tag&gt;]
   |      |      |
</pre>
<p class="figure">Figure 10: Indication of CoAP GET protected with OSCOAP. The brackets [ ... ] indicate a COSE object. The brackets { ... } indicate encrypted data.</p>
<p id="rfc.section.B.1.p.2">Since the unprotected request message (GET) has no payload, the Object-Security option carries the COSE object as its value.  Since the unprotected response message (Content) has payload ("OFF"), the COSE object (indicated with [ &#8230; ]) is carried as the CoAP payload.</p>
<p id="rfc.section.B.1.p.3">The COSE header of the request contains a Context Identifier (cid:5fdc), indicating which security context was used to protect the message and a Sequence Number (seq:42).</p>
<p id="rfc.section.B.1.p.4">The option Uri-Path (alarm_status) and payload ("OFF") are formatted as indicated in <a href="#sec-obj-cose">Section 5</a>, and encrypted in the COSE Cipher Text (indicated with { &#8230; }).</p>
<p id="rfc.section.B.1.p.5">The server verifies that the Sequence Number has not been received before (see <a href="#replay-protection-section">Section 6.1</a>). The client verifies that the Sequence Number has not been received before and that the response message is generated as a response to the sent request message (see <a href="#replay-protection-section">Section 6.1</a>).</p>
<h1 id="rfc.appendix.B.2"><a href="#rfc.appendix.B.2">B.2.</a> <a href="#secure-subscribe-to-sensor" id="secure-subscribe-to-sensor">Secure Subscribe to Sensor</a></h1>
<p id="rfc.section.B.2.p.1">Here is an example targeting the scenario in the Forwarding with observe case  of <a href="#I-D.hartke-core-e2e-security-reqs">[I-D.hartke-core-e2e-security-reqs]</a>. The example illustrates a client requesting subscription to a blood sugar measurement resource (GET /glucose), and first receiving the value 220 mg/dl, and then a second reading with value 180 mg/dl. The CoAP options Observe, Uri-Path, Content-Format, and Payload are encrypted and integrity protected, and the CoAP header field Code is integrity protected (see <a href="#coap-headers-and-options">Section 4</a>).</p>
<div id="rfc.figure.11"/>
<div id="get-protected-enc"/>
<pre>
Client  Proxy  Server
   |      |      |
   +-----&gt;|      |            Code: 0.01 (GET)
   | GET  |      |           Token: 0x83
   |      |      |         Observe: 0
   |      |      | Object-Security: [cid:ca, seq:15b7, {Observe:0,
   |      |      |                   Uri-Path:"glucose"}, &lt;Tag&gt;]
   |      |      |         Payload: -
   |      |      |
   |      +-----&gt;|            Code: 0.01 (GET)
   |      | GET  |           Token: 0xbe
   |      |      |         Observe: 0
   |      |      | Object-Security: [cid:ca, seq:15b7, {Observe:0,
   |      |      |                   Uri-Path:"glucose"}, &lt;Tag&gt;]
   |      |      |         Payload: -
   |      |      |
   |      |&lt;-----+            Code: 2.05 (Content)
   |      | 2.05 |           Token: 0xbe
   |      |      |         Max-Age: 0
   |      |      |         Observe: 1
   |      |      | Object-Security: -
   |      |      |         Payload: [seq:32c2, {Observe:1, 
   |      |      |                   Content-Format:0, "220"}, &lt;Tag&gt;]
   |      |      |
   |&lt;-----+      |            Code: 2.05 (Content)
   | 2.05 |      |           Token: 0x83
   |      |      |         Max-Age: 0
   |      |      |         Observe: 1
   |      |      | Object-Security: -
   |      |      |         Payload: [seq:32c2, {Observe:1,
   |      |      |                   Content-Format:0, "220"}, &lt;Tag&gt;]
  ...    ...    ...
   |      |      |
   |      |&lt;-----+            Code: 2.05 (Content)
   |      | 2.05 |           Token: 0xbe
   |      |      |         Max-Age: 0
   |      |      |         Observe: 2
   |      |      | Object-Security: -
   |      |      |         Payload: [seq:32c6, {Observe:2, 
   |      |      |                   Content-Format:0, "180"}, &lt;Tag&gt;]
   |      |      |
   |&lt;-----+      |            Code: 2.05 (Content)
   | 2.05 |      |           Token: 0x83
   |      |      |         Max-Age: 0
   |      |      |         Observe: 2
   |      |      | Object-Security: -
   |      |      |         Payload: [seq:32c6, {Observe:2,
   |      |      |                   Content-Format:0, "180"}, &lt;Tag&gt;]
   |      |      |
</pre>
<p class="figure">Figure 11: Indication of CoAP GET protected with OSCOAP. The brackets [ ... ] indicates COSE object. The bracket { ... } indicates encrypted data.</p>
<p id="rfc.section.B.2.p.2">Since the unprotected request message (GET) has no payload, the COSE object (indicated with [ &#8230; ]) is carried in the Object-Security option value. Since the unprotected response message (Content) has payload, the Object-Security option is empty, and the COSE object is carried as the payload.</p>
<p id="rfc.section.B.2.p.3">The COSE header of the request contains a Context Identifier (cid:ca), indicating which security context was used to protect the message and a Sequence Number (seq:15b7).</p>
<p id="rfc.section.B.2.p.4">The options Observe, Content-Format and the payload are formatted as indicated in <a href="#sec-obj-cose">Section 5</a>, and encrypted in the COSE cipher text (indicated with { &#8230; }).</p>
<p id="rfc.section.B.2.p.5">The server verifies that the Sequence Number has not been received before (see <a href="#replay-protection-section">Section 6.1</a>). The client verifies that the Sequence Number has not been received before and that the response message is generated as a response to the subscribe request.</p>
<h1 id="rfc.appendix.C"><a href="#rfc.appendix.C">Appendix C.</a> <a href="#mode-payl" id="mode-payl">Object Security of Content (OSCON)</a></h1>
<p id="rfc.section.C.p.1">OSCOAP protects message exchanges end-to-end between a certain client and a certain server, targeting the security requirements for forward proxy of <a href="#I-D.hartke-core-e2e-security-reqs">[I-D.hartke-core-e2e-security-reqs]</a>. In contrast, many use cases require one and the same message to be protected for, and verified by, multiple endpoints, see caching proxy section of <a href="#I-D.hartke-core-e2e-security-reqs">[I-D.hartke-core-e2e-security-reqs]</a>. Those security requirements can be addressed by protecting essentially the payload/content of individual messages using the COSE format (<a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>), rather than the entire request/response message exchange. This is referred to as Object Security of Content (OSCON).</p>
<p id="rfc.section.C.p.2">OSCON transforms an unprotected CoAP message into a protected CoAP message in the following way: the payload of the unprotected CoAP message is wrapped by a COSE object, which replaces the payload of the unprotected CoAP message. We call the result the "protected" CoAP message.</p>
<p id="rfc.section.C.p.3">The unprotected payload shall be the plaintext/payload of the COSE object.  The 'protected' field of the COSE object 'Headers' shall include the context identifier, both for requests and responses.  If the unprotected CoAP message includes a Content-Format option, then the COSE object shall include a protected 'content type' field, whose value is set to the unprotected message Content-Format value. The Content-Format option of the protected CoAP message shall be replaced with "application/oscon" (<a href="#iana">Section 9</a>)</p>
<p id="rfc.section.C.p.4">The COSE object shall be protected (encrypted) and verified (decrypted) as described in (<a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>).</p>
<p id="rfc.section.C.p.5">In the case of symmetric encryption, the same key and IV shall not be used twice. Sequence numbers for partial IV as specified for OSCOAP may be used for replay protection as described in <a href="#replay-protection-section">Section 6.1</a>. The use of time stamps in the COSE header parameter 'operation time' <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a> for freshness may be used.</p>
<p id="rfc.section.C.p.6">OSCON shall not be used in cases where CoAP header fields (such as Code or Version) or CoAP options need to be integrity protected or encrypted. OSCON shall not be used in cases which require a secure binding between request and response.</p>
<p id="rfc.section.C.p.7">The scenarios in Sections 3.3 - 3.5 of <a href="#I-D.hartke-core-e2e-security-reqs">[I-D.hartke-core-e2e-security-reqs]</a> assume multiple recipients for a particular content. In this case the use of symmetric keys does not provide data origin authentication. Therefore the COSE object should in general be protected with a digital signature.</p>
<h1 id="rfc.appendix.C.1"><a href="#rfc.appendix.C.1">C.1.</a> <a href="#appendix-c" id="appendix-c">Overhead OSCON</a></h1>
<p id="rfc.section.C.1.p.1">In general there are four different kinds of ciphersuites that need to be supported: message authentication code, digital signature, authenticated encryption, and symmetric encryption + digital signature. The use of digital signature is necessary for applications with many legitimate recipients of a given message, and where data origin authentication is required.</p>
<p id="rfc.section.C.1.p.2">To distinguish between these different cases, the tagged structures of COSE are used (see Section 2 of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>).</p>
<p id="rfc.section.C.1.p.3">The size of the COSE message for selected algorithms are detailed in this section.</p>
<p id="rfc.section.C.1.p.4">The size of the header is shown separately from the size of the MAC/signature.  A 4-byte Context Identifier and a 1-byte Sequence Number are used throughout all examples, with these values:</p>
<p/>

<ul>
  <li>Cid: 0xa1534e3c</li>
  <li>Seq: 0xa3</li>
</ul>
<p id="rfc.section.C.1.p.6">For each scheme, we indicate the fixed length of these two parameters ("Cid+Seq" column) and of the Tag ("MAC"/"SIG"/"TAG"). The "Message OH" column shows the total expansions of the CoAP message size, while the "COSE OH" column is calculated from the previous columns following the formula in <a href="#mess-exp-formula">Figure 7</a>.</p>
<p id="rfc.section.C.1.p.7">Overhead incurring from CBOR encoding is also included in the COSE overhead count.</p>
<p id="rfc.section.C.1.p.8">To make it easier to read, COSE objects are represented using CBOR's diagnostic notation rather than a binary dump.</p>
<h1 id="rfc.appendix.C.2"><a href="#rfc.appendix.C.2">C.2.</a> <a href="#ssm-mac" id="ssm-mac">MAC Only</a></h1>
<p id="rfc.section.C.2.p.1">This example is based on HMAC-SHA256, with truncation to 8 bytes (HMAC 256/64).</p>
<p id="rfc.section.C.2.p.2">Since the key is implicitly known by the recipient, the COSE_Mac0_Tagged structure is used (Section 6.2 of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>).</p>
<p id="rfc.section.C.2.p.3">The object in COSE encoding gives:</p>
<pre>
996(                         # COSE_Mac0_Tagged
  [
    h'a20444a1534e3c0641a3', # protected:
                               {04:h'a1534e3c',
                                06:h'a3'}
    {},                      # unprotected
    h'',                     # payload
    MAC                      # truncated 8-byte MAC
  ]
)
</pre>
<p id="rfc.section.C.2.p.4">This COSE object encodes to a total size of 26 bytes.</p>
<p><a href="#comp-hmac-sha256">Figure 12</a> summarizes these results.</p>
<div id="rfc.figure.12"/>
<div id="comp-hmac-sha256"/>
<pre>
+------------------+-----+-----+---------+------------+
|     Structure    | Tid | MAC | COSE OH | Message OH |
+------------------+-----+-----+---------+------------+
| COSE_Mac0_Tagged | 5 B | 8 B |   13 B  |    26 B    |
+------------------+-----+-----+---------+------------+
</pre>
<p class="figure">Figure 12: Message overhead for a 5-byte Tid using HMAC 256/64</p>
<h1 id="rfc.appendix.C.3"><a href="#rfc.appendix.C.3">C.3.</a> <a href="#ssm-dig-sig" id="ssm-dig-sig">Signature Only</a></h1>
<p id="rfc.section.C.3.p.1">This example is based on ECDSA, with a signature of 64 bytes.</p>
<p id="rfc.section.C.3.p.2">Since only one signature is used, the COSE_Sign1_Tagged structure is used (Section 4.2 of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>).</p>
<p id="rfc.section.C.3.p.3">The object in COSE encoding gives:</p>
<pre>
997(                         # COSE_Sign1_Tagged
  [
    h'a20444a1534e3c0641a3', # protected:
                               {04:h'a1534e3c',
                                06:h'a3'}
    {},                      # unprotected
    h'',                     # payload
    SIG                      # 64-byte signature
  ]
)
</pre>
<p id="rfc.section.C.3.p.4">This COSE object encodes to a total size of 83 bytes.</p>
<p><a href="#comp-ecdsa">Figure 13</a> summarizes these results.</p>
<div id="rfc.figure.13"/>
<div id="comp-ecdsa"/>
<pre>
+-------------------+-----+------+---------+------------+
|     Structure     | Tid |  SIG | COSE OH | Message OH |
+-------------------+-----+------+---------+------------+
| COSE_Sign1_Tagged | 5 B | 64 B |   14 B  |  83 bytes  |
+-------------------+-----+------+---------+------------+
</pre>
<p class="figure">Figure 13: Message overhead for a 5-byte Tid using 64 byte ECDSA signature.</p>
<h1 id="rfc.appendix.C.4"><a href="#rfc.appendix.C.4">C.4.</a> <a href="#sem-auth-enc" id="sem-auth-enc">Authenticated Encryption with Additional Data (AEAD)</a></h1>
<p id="rfc.section.C.4.p.1">This example is based on AES-CCM with the MAC truncated to 8 bytes.</p>
<p id="rfc.section.C.4.p.2">It is assumed that the IV is generated from the Sequence Number and some previously agreed upon static IV. This means it is not required to explicitly send the whole IV in the message.</p>
<p id="rfc.section.C.4.p.3">Since the key is implicitly known by the recipient, the COSE_Encrypt0_Tagged structure is used (Section 5.2 of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>).</p>
<p id="rfc.section.C.4.p.4">The object in COSE encoding gives:</p>
<pre>
993(                         # COSE_Encrypt0_Tagged
  [
    h'a20444a1534e3c0641a3', # protected:
                               {04:h'a1534e3c',
                                06:h'a3'}
    {},                      # unprotected
    TAG                      # cipher text + truncated 8-byte TAG
  ]
)
</pre>
<p id="rfc.section.C.4.p.5">This COSE object encodes to a total size of 25 bytes.</p>
<p><a href="#comp-aes-ccm">Figure 14</a> summarizes these results.</p>
<div id="rfc.figure.14"/>
<div id="comp-aes-ccm"/>
<pre>
+----------------------+-----+-----+---------+------------+
|       Structure      | Tid | TAG | COSE OH | Message OH |
+----------------------+-----+-----+---------+------------+
| COSE_Encrypt0_Tagged | 5 B | 8 B |   12 B  |  25 bytes  |
+----------------------+-----+-----+---------+------------+
</pre>
<p class="figure">Figure 14: Message overhead for a 5-byte Tid using AES_128_CCM_8.</p>
<h1 id="rfc.appendix.C.5"><a href="#rfc.appendix.C.5">C.5.</a> <a href="#sem-seds" id="sem-seds">Symmetric Encryption with Asymmetric Signature (SEAS)</a></h1>
<p id="rfc.section.C.5.p.1">This example is based on AES-CCM and ECDSA with 64 bytes signature. The same assumption on the security context as in <a href="#sem-auth-enc">Appendix C.4</a>.  COSE defines the field 'counter signature w/o headers' that is used here to sign a COSE_Encrypt0_Tagged message (see Section 3 of <a href="#I-D.ietf-cose-msg">[I-D.ietf-cose-msg]</a>).</p>
<p id="rfc.section.C.5.p.2">The object in COSE encoding gives:</p>
<pre>
993(                         # COSE_Encrypt0_Tagged
  [
    h'a20444a1534e3c0641a3', # protected:
                               {04:h'a1534e3c',
                                06:h'a3'}
    {9:SIG},                 # unprotected: 
                                09: 64 bytes signature
    TAG                      # cipher text + truncated 8-byte TAG
  ]
)
</pre>
<p id="rfc.section.C.5.p.3">This COSE object encodes to a total size of 92 bytes.</p>
<p><a href="#comp-aes-ccm-ecdsa">Figure 15</a> summarizes these results.</p>
<div id="rfc.figure.15"/>
<div id="comp-aes-ccm-ecdsa"/>
<pre>
+----------------------+-----+-----+------+---------+------------+
|       Structure      | Tid | TAG | SIG  | COSE OH | Message OH |
+----------------------+-----+-----+------+---------+------------+
| COSE_Encrypt0_Tagged | 5 B | 8 B | 64 B |   15 B  |    92 B    |
+----------------------+-----+-----+------+---------+------------+
</pre>
<p class="figure">Figure 15: Message overhead for a 5-byte Tid using AES-CCM countersigned with ECDSA.</p>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Authors' Addresses</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Goeran Selander</span> 
	  <span class="n hidden">
		<span class="family-name">Selander</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson AB</span>
	<span class="adr">
	  <span class="vcardline">Farogatan 6</span>

	  <span class="vcardline">
		<span class="locality">Kista</span>,  
		<span class="region"></span>
		<span class="code">SE-16480 Stockholm</span>
	  </span>
	  <span class="country-name vcardline">Sweden</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:goran.selander@ericsson.com">goran.selander@ericsson.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">John Mattsson</span> 
	  <span class="n hidden">
		<span class="family-name">Mattsson</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson AB</span>
	<span class="adr">
	  <span class="vcardline">Farogatan 6</span>

	  <span class="vcardline">
		<span class="locality">Kista</span>,  
		<span class="region"></span>
		<span class="code">SE-16480 Stockholm</span>
	  </span>
	  <span class="country-name vcardline">Sweden</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:john.mattsson@ericsson.com">john.mattsson@ericsson.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Francesca Palombini</span> 
	  <span class="n hidden">
		<span class="family-name">Palombini</span>
	  </span>
	</span>
	<span class="org vcardline">Ericsson AB</span>
	<span class="adr">
	  <span class="vcardline">Farogatan 6</span>

	  <span class="vcardline">
		<span class="locality">Kista</span>,  
		<span class="region"></span>
		<span class="code">SE-16480 Stockholm</span>
	  </span>
	  <span class="country-name vcardline">Sweden</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:francesca.palombini@ericsson.com">francesca.palombini@ericsson.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Ludwig Seitz</span> 
	  <span class="n hidden">
		<span class="family-name">Seitz</span>
	  </span>
	</span>
	<span class="org vcardline">SICS Swedish ICT</span>
	<span class="adr">
	  <span class="vcardline">Scheelevagen 17</span>

	  <span class="vcardline">
		<span class="locality">Lund</span>,  
		<span class="region"></span>
		<span class="code">22370</span>
	  </span>
	  <span class="country-name vcardline">Sweden</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ludwig@sics.se">ludwig@sics.se</a></span>

  </address>
</div>

  <div class="github-fork-ribbon-wrapper"><div class="github-fork-ribbon"><a href="https://github.com/EricssonResearch/OSCOAP">Fork me on GitHub</a></div></div>
</body>
</html>
